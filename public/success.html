<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful</title>
    <style>
        :root { --neon: #00ff41; --dark: #0d1117; --text: #e6edf3; }
        body { background-color: var(--dark); color: var(--text); font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { text-align: center; }
        h1 { color: var(--neon); }
    </style>
</head>
<body>
    <div class="container">
        <h1>UPDATING CLEARANCE LEVEL...</h1>
        <p>Your access is being provisioned. Please do not close this window.</p>
        <p>Redirecting shortly...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDBfuowc1DemVHebL01Bdx_g87b3i0Wc4A",
        authDomain: "chipper-bridge-8675.firebaseapp.com",
        projectId: "chipper-bridge-8675",
        storageBucket: "chipper-bridge-8675.appspot.com",
        messagingSenderId: "561587100404",
        appId: "1:561587100404:web:69a9aca3ff3c3ed64c5ca1"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      function getQueryParam(param) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(param);
      }

      function updateUserPlan() {
          const plan = getQueryParam('plan'); // Expects ?plan=operative or ?plan=godmode
          if (!plan) {
              console.error("No plan specified in URL.");
              window.location.href = '/index.html';
              return;
          }

          auth.onAuthStateChanged(user => {
              if (user) {
                  // User is logged in, update their document
                  const userRef = db.collection('users').doc(user.uid);
                  userRef.update({
                      plan: plan.toUpperCase()
                  })
                  .then(() => {
                      console.log("User plan updated to " + plan.toUpperCase());
                      // Redirect to the main page after a short delay
                      setTimeout(() => {
                          window.location.href = '/index.html';
                      }, 3000);
                  })
                  .catch(error => {
                      console.error("Error updating user plan: ", error);
                      // Redirect anyway, but log the error
                      window.location.href = '/index.html';
                  });
              } else {
                  // User is not logged in. This should not happen in a real scenario
                  // as they should create an account before paying.
                  // For now, we redirect them.
                  console.log("User not logged in. Redirecting.");
                  window.location.href = '/index.html';
              }
          });
      }

      // Run the logic when the page loads
      document.addEventListener('DOMContentLoaded', updateUserPlan);
    </script>
</body>
</html>
